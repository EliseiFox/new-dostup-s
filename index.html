<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #messages { margin-bottom: 10px; }
        #input { width: calc(100% - 100px); }
        #sendButton { width: 80px; }
        #connectButton { width: 150px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>P2P Chat</h1>
    <div id="messages"></div>
    <input type="text" id="input" placeholder="Type a message...">
    <button id="sendButton">Send</button>
    <button id="connectButton">Generate Offer</button>
    
    <h2>Offer SDP</h2>
    <textarea id="offer" class="hidden" rows="6" cols="60" readonly></textarea>
    
    <h2>Answer SDP</h2>
    <textarea id="answer" class="hidden" rows="6" cols="60" readonly></textarea>

    <h2>ICE Candidates</h2>
    <textarea id="iceCandidates" class="hidden" rows="6" cols="60" readonly></textarea>
    
    <script>
        const messagesDiv = document.getElementById('messages');
        const input = document.getElementById('input');
        const sendButton = document.getElementById('sendButton');
        const connectButton = document.getElementById('connectButton');
        const offerTextarea = document.getElementById('offer');
        const answerTextarea = document.getElementById('answer');
        const iceCandidatesTextarea = document.getElementById('iceCandidates');

        let peerConnection;
        let dataChannel;

        function logMessage(message) {
            messagesDiv.innerHTML += `<p>${message}</p>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function createConnection() {
            peerConnection = new RTCPeerConnection();
            dataChannel = peerConnection.createDataChannel('chat');

            dataChannel.onmessage = (event) => {
                logMessage('Peer: ' + event.data);
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    iceCandidatesTextarea.value += JSON.stringify(event.candidate) + '\n';
                }
            };

            peerConnection.createOffer().then((offer) => {
                return peerConnection.setLocalDescription(offer);
            }).then(() => {
                offerTextarea.value = peerConnection.localDescription.sdp;
            }).catch(console.error);
        }

        function handleOffer(offer) {
            peerConnection = new RTCPeerConnection();
            dataChannel = peerConnection.createDataChannel('chat');

            dataChannel.onmessage = (event) => {
                logMessage('Peer: ' + event.data);
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    iceCandidatesTextarea.value += JSON.stringify(event.candidate) + '\n';
                }
            };

            peerConnection.setRemoteDescription(new RTCSessionDescription(offer)).then(() => {
                return peerConnection.createAnswer();
            }).then((answer) => {
                return peerConnection.setLocalDescription(answer);
            }).then(() => {
                answerTextarea.value = peerConnection.localDescription.sdp;
            }).catch(console.error);
        }

        function handleAnswer(answer) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(answer)).catch(console.error);
        }

        function handleIceCandidate(candidate) {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
        }

        function sendMessage() {
            const message = input.value;
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(message);
                logMessage('You: ' + message);
                input.value = '';
            }
        }

        sendButton.addEventListener('click', sendMessage);

        connectButton.addEventListener('click', () => {
            const offer = prompt('Enter offer SDP:');
            if (offer) {
                handleOffer(offer);
            }

            const answer = prompt('Enter answer SDP:');
            if (answer) {
                handleAnswer(answer);
            }

            const iceCandidate = prompt('Enter ICE candidate:');
            if (iceCandidate) {
                handleIceCandidate(iceCandidate);
            }
        });

        // Генерация предложения (Offer) при загрузке страницы
        createConnection();
    </script>
</body>
</html>
